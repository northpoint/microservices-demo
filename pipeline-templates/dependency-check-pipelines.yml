parameters:
- name: project
  default: 'unknown'
- name: language
  default: ''
- name: cliSources
  default: $(Build.Repository.LocalPath)

steps:
- task: Bash@3
  displayName: Download dependency check
  inputs:
    targetType: 'inline'
    script: |
      cd $(Agent.ToolsDirectory)

      gpg --keyserver hkp://keys.gnupg.net --recv-keys F9514E84AE3708288374BBBE097586CFEA37F9A6;
      
      curl https://dl.bintray.com/jeremy-long/owasp/dependency-check-5.3.2-release.zip -OL;

      curl https://dl.bintray.com/jeremy-long/owasp/dependency-check-5.3.2-release.zip.asc -OL;
      
      gpg --verify dependency-check-5.3.2-release.zip.asc;

      unzip dependency-check-5.3.2-release.zip;

- task: Bash@3
  displayName: Run Dependency Check
  inputs:
    targetType: 'inline'
    script: '$(Agent.ToolsDirectory)/dependency-check/bin/dependency-check.sh --project ${{ parameters.project }} --scan ${{ parameters.cliSources }} --out $(Build.ArtifactStagingDirectory) --format ALL --enableExperimental'

- task: PublishBuildArtifacts@1
  displayName: Publish results
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'dependency-check'
    publishLocation: 'Container'
